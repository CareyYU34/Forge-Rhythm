<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <!-- ==================== Meta Data ==================== -->
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Forge Rhythm</title>
        <!-- ==================== CSS ==================== -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            crossorigin="anonymous"
        />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
            rel="stylesheet"
        /> 
        <link href="./activities.css" rel="stylesheet" />
    </head>
    <body>
        <header class="navbar navbar-expand-lg sticky-top">
            <div class="container py-2 d-flex justify-content-between align-items-center">
                <a class="navbar-brand text-light brand-badge fw-semibold" href="#">
                    <i class="bi bi-soundwave"></i><span class="brand-dot"></span> Forge Rhythm
                </a>
            </div>
        </header>
        <main>
            <div class="container">
                <section class="hero glass-card p-4 p-md-5 mx-auto text-center" style="max-width: 720px">
                    <h1 class="display-6 fw-semibold mb-3">MIDI 播放控制台</h1>
                    <p class="text-secondary mb-4">
                        請載入 MIDI 檔並選擇鼓組音色進行播放測試。
                    </p>
                    <div class="inner-card card border-0 shadow-sm p-4">
                        <div class="d-grid gap-3">
                            <input type="file" id="midiFileInput" accept=".mid,.midi" style="display: none" />
                            <div class="d-flex flex-wrap justify-content-center gap-3">
                                <button class="btn btn-primary btn-glow" id="loadMidiButton">
                                    <i class="bi bi-file-earmark-music me-2"></i> 載入 MIDI
                                </button>

                                <select id="selectDrumKit" class="form-select bg-dark text-light" style="max-width: 200px">
                                    <option value="standardKit">標準</option>
                                    <!-- <option value="roomKit">流行</option>
                                    <option value="powerKit">搖滾</option>
                                    <option value="jazzKit">爵士</option>
                                    <option value="electronicKit">電子</option> -->
                                </select>

                                <button class="btn btn-outline-success btn-glow" id="playSoundButton" hidden>
                                    <i class="bi bi-play-circle-fill me-1"></i> 播放
                                </button>
                                <button class="btn btn-outline-danger btn-glow" id="stopSoundButton" hidden>
                                    <i class="bi bi-pause-circle-fill me-1"></i> 暫停
                                </button>
                            </div>
                            <div id="fileInfo">尚未載入檔案</div>
                        </div>
                    </div>  
                </section>
            </div>
        </main>        
        <footer class="py-3 small text-center">
            <span>© <span id="year"></span> Forge Rhythm</span>
        </footer>
        <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

        <!-- Tone.js MIDI -->
        <script src="https://unpkg.com/@tonejs/midi"></script>
        <!-- My JS -->
        <script src="./js/player.js"></script>
        <script>
            const player = new MidiPlayer();
            const midiInput = document.getElementById("midiFileInput");
            const selectDrumKit = document.getElementById("selectDrumKit"); //還未製作
            const playSoundButton = document.getElementById("playSoundButton");
            const stopSoundButton = document.getElementById("stopSoundButton");
            const midiInfo = document.getElementById("fileInfo");

            loadMidiButton.addEventListener("click", () => {
                midiInput.click();
            });

            midiInput.addEventListener("change", async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                midiInfo.textContent = `載入中：${file.name}`;

                // playSoundButton.hidden = true;
                // stopSoundButton.hidden = true;

                const arrayBuffer = await file.arrayBuffer();
                const midi = new Midi(arrayBuffer);
                await player.onMidiLoaded(midi);
                await player.prepareAudio()

                midiInfo.textContent = `已載入：${file.name}`;

                playSoundButton.hidden = false;
                stopSoundButton.hidden = true;
            });

            //播放
            playSoundButton.addEventListener("click", () => {
                playSoundButton.hidden = true;
                stopSoundButton.hidden = false;
                player.play();
            });

            //暫停
            stopSoundButton.addEventListener("click", () => {
                stopSoundButton.hidden = true;
                playSoundButton.hidden = false;
                player.pause();
            });
        </script>
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            crossorigin="anonymous"
        ></script>  
    </body>
</html>